import tensorflow as tf
import numpy as np
import cv2 as cv
import copy

from tensorflow.keras import backend as K
from scipy.ndimage.interpolation import zoom

def generate_grad_cam(model, inputs, class_name, activation_layer):

    # gradients = optimizer.get_gradients(model.output[class_name][0][0], A_k)
    ## 이미지 텐서를 입력해서
    ## 해당 액티베이션 레이어의 아웃풋(a_k)과
    ## 소프트맥스 함수 인풋의 a_k에 대한 gradient를 구한다.
    # get_output = K.function([model.input[0],model.input[1], model.input[2]],
    #                         [A_k, gradients])

    input_images, saliency_maps_retina = [], []
    for (batch_idx, (batch)) in enumerate(inputs):
        this_img_id=batch[1]['img_id'].numpy()[0].decode('utf-8')
        # if batch_idx not in [14799, 17732, 19282, 21955, 22384, 24583, 26477, 28001, 29143, 30886]:
        if this_img_id not in ['228382_2.jpg','228382_1.jpg','233693_1.jpg','233693_2.jpg','237016_1.jpg','237016_2.jpg','246269_2.jpg','246269_1.jpg','249264_1.jpg','249264_2.jpg','245105_2.jpg','245105_1.jpg','251066_1.jpg','251066_2.jpg','102625_1.jpg','102625_2.jpg','106335_2.jpg','106335_1.jpg','104336_1.jpg','104336_2.jpg']:
          continue

        with tf.GradientTape() as tape:
            print('batch_idx, this_img_id',batch_idx, this_img_id)
            predictions = model([batch[0]['image'], batch[0]['age'], batch[0]['sex'], batch[0]['blood'], batch[0]['bilirubin'], batch[0]['urobilinogen'], batch[0]['ketone'], batch[0]['protein'], batch[0]['nitrite'], batch[0]['glucose'], batch[0]['leucocyte'], batch[0]['ph'], batch[0]['sg']], training=False)
            grad_val = tape.gradient(predictions['gt60'], predictions['A_K'])
            # print(grad_val.numpy())

        # [conv_output, grad_val] = get_output([batch[0]['image'], batch[0]['sex'], batch[0]['age']])
        conv_output = predictions['A_K'][0]
        ## 배치 사이즈가 1이므로 배치 차원을 없앤다.
        # predictions = conv_output[0]
        # print(grad_val.shape)
        grad_val = grad_val[0]
        # print(conv_output.shape)
        # print(grad_val.shape)

        ## 구한 gradient를 픽셀 가로세로로 평균내서 a^c_k를 구한다.
        weights = np.mean(grad_val, axis=(0, 1))

        ## 추출한 conv_output에 weight를 곱하고 합하여 grad_cam을 얻는다.
        grad_cam = np.zeros(dtype=np.float32, shape=conv_output.shape[0:2])
        for k, w in enumerate(weights):
            grad_cam += w * conv_output[:, :, k]

        grad_cam = grad_cam.numpy()
        grad_cam = cv.resize(grad_cam, (512, 512))

        ## ReLU를 씌워 음수를 0으로 만든다.
        grad_cam = np.maximum(grad_cam, 0)

        grad_cam = grad_cam / grad_cam.max()
        input_images.append(batch[1]['ori_image'][0].numpy())
        saliency_maps_retina.append(grad_cam)

    return input_images, saliency_maps_retina

def getVanillaSaliencyMap(model, inputs, class_name, activation_layer):

    # gradients = optimizer.get_gradients(model.output[class_name][0][0], A_k)
    ## 이미지 텐서를 입력해서
    ## 해당 액티베이션 레이어의 아웃풋(a_k)과
    ## 소프트맥스 함수 인풋의 a_k에 대한 gradient를 구한다.
    # get_output = K.function([model.input[0],model.input[1], model.input[2]],
    #                         [A_k, gradients])

    input_images, saliency_maps_retina = [], []
    for (batch_idx, (batch)) in enumerate(inputs):
        this_img_id=batch[1]['img_id'].numpy()[0].decode('utf-8')
        # young correct (train, mmdl)
        # if this_img_id not in ["77_1.jpg","77_2.jpg","102_1.jpg","102_2.jpg","632_1.jpg","632_2.jpg","940_2.jpg","940_1.jpg","1496_2.jpg","1496_1.jpg","1573_2.jpg","1573_1.jpg","2735_1.jpg","2735_2.jpg","4399_1.jpg","4399_2.jpg","6044_1.jpg","6044_2.jpg","8989_1.jpg","8989_2.jpg","9212_1.jpg","9212_2.jpg","9443_1.jpg","9443_2.jpg","9949_1.jpg","9949_2.jpg","14584_1.jpg","14584_2.jpg","15649_1.jpg","15649_2.jpg","15834_2.jpg","15834_1.jpg","16434_1.jpg","16434_2.jpg","16588_1.jpg","16588_2.jpg","17030_1.jpg","17030_2.jpg","18701_1.jpg","18701_2.jpg","25120_1.jpg","25120_2.jpg","26545_1.jpg","26545_2.jpg","29867_1.jpg","29867_2.jpg","33822_1.jpg","33822_2.jpg","34101_1.jpg","34101_2.jpg","42742_2.jpg","42742_1.jpg","44009_1.jpg","44009_2.jpg","45856_1.jpg","45856_2.jpg","51584_1.jpg","51584_2.jpg","51926_1.jpg","51926_2.jpg","55027_1.jpg","55027_2.jpg","58160_1.jpg","58160_2.jpg","61742_1.jpg","61742_2.jpg","63333_1.jpg","63333_2.jpg","63862_1.jpg","63862_2.jpg","70037_1.jpg","70037_2.jpg","71986_2.jpg","71986_1.jpg","72259_1.jpg","72259_2.jpg","72925_1.jpg","72925_2.jpg","73107_1.jpg","73107_2.jpg","73191_1.jpg","73191_2.jpg","73201_2.jpg","73201_1.jpg","73935_1.jpg","73935_2.jpg","74505_1.jpg","74505_2.jpg","75088_1.jpg","75088_2.jpg","75418_1.jpg","75418_2.jpg","76223_2.jpg","76223_1.jpg","76712_1.jpg","76712_2.jpg","77075_1.jpg","77075_2.jpg","77477_2.jpg","77477_1.jpg","78135_1.jpg","78135_2.jpg","78307_1.jpg","78307_2.jpg","78353_1.jpg","78353_2.jpg","79137_1.jpg","79137_2.jpg","79261_1.jpg","79261_2.jpg","79818_1.jpg","79818_2.jpg","80026_1.jpg","80026_2.jpg","80392_1.jpg","80392_2.jpg","80575_1.jpg","80575_2.jpg","81990_1.jpg","81990_2.jpg","83005_1.jpg","83005_2.jpg","83584_1.jpg","83584_2.jpg","85247_1.jpg","85247_2.jpg","85301_1.jpg","85301_2.jpg","87233_1.jpg","87233_2.jpg","87786_1.jpg","87786_2.jpg","88288_2.jpg","88288_1.jpg","88385_1.jpg","88385_2.jpg","88645_1.jpg","88645_2.jpg","90385_1.jpg","90385_2.jpg","90454_1.jpg","90454_2.jpg","90834_1.jpg","90834_2.jpg","91155_2.jpg","91155_1.jpg","91743_1.jpg","91743_2.jpg","306772_1.jpg","306772_2.jpg","309385_1.jpg","309385_2.jpg","309447_2.jpg","309447_1.jpg","310593_2.jpg","310593_3.jpg","313618_1.jpg","313618_2.jpg","319823_1.jpg","319823_2.jpg","320613_1.jpg","320613_2.jpg","221822_1.jpg","221822_2.jpg","221878_1.jpg","221878_2.jpg","222083_2.jpg","222083_1.jpg","228228_2.jpg","228228_1.jpg","228471_2.jpg","228471_1.jpg","223080_2.jpg","223080_1.jpg","226405_2.jpg","226405_1.jpg","229374_2.jpg","229374_1.jpg","223527_1.jpg","223527_2.jpg","229604_2.jpg","229604_1.jpg","230414_2.jpg","230414_1.jpg","224653_2.jpg","224653_1.jpg","227846_1.jpg","227846_2.jpg","227883_2.jpg","227883_1.jpg","230781_2.jpg","230781_1.jpg","230885_1.jpg","230885_2.jpg","241878_2.jpg","241878_1.jpg","236320_2.jpg","236320_1.jpg","242902_2.jpg","242902_1.jpg","242954_1.jpg","242954_2.jpg","233360_2.jpg","233360_1.jpg","236548_2.jpg","236548_1.jpg","236667_2.jpg","236667_1.jpg","239387_1.jpg","239387_2.jpg","233825_1.jpg","233825_2.jpg","236993_2.jpg","236993_1.jpg","234207_2.jpg","234207_1.jpg","237220_1.jpg","237220_2.jpg","240171_1.jpg","240171_2.jpg","242536_2.jpg","242536_1.jpg","237693_2.jpg","237693_1.jpg","237767_2.jpg","237767_1.jpg","240562_1.jpg","240562_2.jpg","242678_1.jpg","242678_2.jpg","234946_2.jpg","234946_1.jpg","238008_1.jpg","238008_2.jpg","240721_2.jpg","240721_1.jpg","232345_2.jpg","232345_1.jpg","232658_2.jpg","232658_1.jpg","238729_2.jpg","238729_1.jpg","238737_2.jpg","238737_1.jpg","235797_1.jpg","235797_2.jpg","235801_1.jpg","235801_2.jpg","246003_1.jpg","246003_2.jpg","248815_2.jpg","248815_1.jpg","248933_2.jpg","248933_1.jpg","251900_1.jpg","251900_2.jpg","254821_2.jpg","254821_1.jpg","254928_1.jpg","254928_2.jpg","246154_1.jpg","246154_2.jpg","255016_2.jpg","255016_1.jpg","255028_1.jpg","255028_3.jpg","252227_2.jpg","252227_1.jpg","252561_1.jpg","252561_2.jpg","246891_1.jpg","246891_2.jpg","246914_1.jpg","246914_2.jpg","249850_1.jpg","249850_2.jpg","249862_2.jpg","249862_1.jpg","247957_2.jpg","247957_1.jpg","248097_2.jpg","248097_1.jpg","254119_2.jpg","254119_1.jpg","254181_1.jpg","254181_2.jpg","248354_2.jpg","248354_1.jpg","266960_2.jpg","266960_1.jpg","263564_2.jpg","263564_1.jpg","258649_2.jpg","258649_1.jpg","261656_1.jpg","261656_2.jpg","102402_2.jpg","102402_1.jpg","102594_1.jpg","102594_2.jpg","107199_1.jpg","107199_2.jpg","107249_1.jpg","107249_2.jpg","100191_2.jpg","100191_1.jpg","100319_1.jpg","100319_2.jpg","101160_1.jpg","101160_2.jpg","106683_1.jpg","106683_2.jpg","107649_1.jpg","107649_2.jpg","107931_2.jpg","107931_1.jpg","107937_1.jpg","107937_2.jpg","107959_1.jpg","107959_2.jpg","108031_1.jpg","108031_2.jpg","106234_1.jpg","106234_2.jpg","106274_1.jpg","106274_2.jpg","106278_1.jpg","106278_2.jpg","106396_1.jpg","106396_2.jpg","109536_1.jpg","109536_2.jpg","109575_2.jpg","109575_1.jpg","109724_1.jpg","109724_2.jpg","109835_2.jpg","109835_1.jpg","110058_1.jpg","110058_2.jpg","110096_2.jpg","110096_1.jpg","110112_2.jpg","110112_1.jpg","109370_1.jpg","109370_2.jpg","109376_3.jpg","109376_4.jpg","111326_1.jpg","111326_2.jpg","111310_2.jpg","111310_1.jpg","108302_1.jpg","108302_2.jpg","108427_1.jpg","108427_2.jpg","111459_1.jpg","111459_2.jpg","108627_2.jpg","108627_1.jpg","108640_1.jpg","108640_2.jpg","108615_1.jpg","108615_2.jpg","110816_2.jpg","110816_1.jpg","110839_1.jpg","110839_2.jpg","110214_1.jpg","110214_2.jpg","110322_1.jpg","110322_2.jpg","111000_1.jpg","111000_2.jpg","109241_1.jpg","109241_3.jpg","109315_1.jpg","109315_2.jpg","103231_1.jpg","103231_2.jpg","103784_1.jpg","103784_2.jpg","104997_1.jpg","104997_2.jpg","105559_1.jpg","105559_2.jpg","105644_1.jpg","105644_2.jpg","105761_2.jpg","105761_1.jpg","23459_4.jpg","23459_2.jpg","63006_3.jpg","63006_2.jpg","100060_3.jpg","100060_2.jpg","104567_4.jpg","104567_3.jpg","106212_3.jpg","106212_1.jpg","106519_2.jpg","106519_1.jpg","106924_3.jpg","106924_4.jpg","106982_4.jpg","106982_3.jpg","107620_3.jpg","107620_2.jpg","107878_4.jpg","107878_3.jpg","108972_4.jpg","108972_3.jpg","109439_3.jpg","109439_5.jpg","109444_5.jpg","109444_3.jpg","110442_1.jpg","110442_3.jpg","110545_3.jpg","110545_4.jpg","110585_2.jpg","110585_1.jpg","110717_4.jpg","110717_1.jpg","111026_2.jpg","111026_5.jpg","111508_3.jpg","111508_1.jpg"]:
        #   continue
        # young all (train, mmdl)
        if this_img_id not in ["77_1.jpg","77_2.jpg","102_1.jpg","102_2.jpg","209_2.jpg","209_1.jpg","632_1.jpg","632_2.jpg","940_2.jpg","940_1.jpg","1350_1.jpg","1350_2.jpg","1496_2.jpg","1496_1.jpg","1573_2.jpg","1573_1.jpg","2735_1.jpg","2735_2.jpg","3794_2.jpg","3794_1.jpg","4399_1.jpg","4399_2.jpg","6044_1.jpg","6044_2.jpg","6673_1.jpg","6673_2.jpg","7720_2.jpg","7720_1.jpg","8989_1.jpg","8989_2.jpg","9212_1.jpg","9212_2.jpg","9443_1.jpg","9443_2.jpg","9488_1.jpg","9488_2.jpg","9949_1.jpg","9949_2.jpg","11473_2.jpg","11473_1.jpg","14584_1.jpg","14584_2.jpg","14730_1.jpg","14730_2.jpg","15649_1.jpg","15649_2.jpg","15834_2.jpg","15834_1.jpg","16148_2.jpg","16148_1.jpg","16434_1.jpg","16434_2.jpg","16588_1.jpg","16588_2.jpg","17030_1.jpg","17030_2.jpg","18701_1.jpg","18701_2.jpg","25120_1.jpg","25120_2.jpg","26545_1.jpg","26545_2.jpg","29867_1.jpg","29867_2.jpg","33822_1.jpg","33822_2.jpg","34101_1.jpg","34101_2.jpg","42742_2.jpg","42742_1.jpg","44009_1.jpg","44009_2.jpg","45856_1.jpg","45856_2.jpg","51584_1.jpg","51584_2.jpg","51926_1.jpg","51926_2.jpg","55027_1.jpg","55027_2.jpg","58160_1.jpg","58160_2.jpg","59445_1.jpg","59445_2.jpg","61742_1.jpg","61742_2.jpg","63333_1.jpg","63333_2.jpg","63862_1.jpg","63862_2.jpg","70037_1.jpg","70037_2.jpg","71358_1.jpg","71358_2.jpg","71986_2.jpg","71986_1.jpg","72259_1.jpg","72259_2.jpg","72925_1.jpg","72925_2.jpg","73107_1.jpg","73107_2.jpg","73191_1.jpg","73191_2.jpg","73201_2.jpg","73201_1.jpg","73935_1.jpg","73935_2.jpg","74505_1.jpg","74505_2.jpg","75088_1.jpg","75088_2.jpg","75418_1.jpg","75418_2.jpg","76121_1.jpg","76121_2.jpg","76223_2.jpg","76223_1.jpg","76712_1.jpg","76712_2.jpg","77075_1.jpg","77075_2.jpg","77477_2.jpg","77477_1.jpg","78106_1.jpg","78106_2.jpg","78107_1.jpg","78107_2.jpg","78135_1.jpg","78135_2.jpg","78307_1.jpg","78307_2.jpg","78353_1.jpg","78353_2.jpg","79137_1.jpg","79137_2.jpg","79261_1.jpg","79261_2.jpg","79818_1.jpg","79818_2.jpg","80026_1.jpg","80026_2.jpg","80392_1.jpg","80392_2.jpg","80575_1.jpg","80575_2.jpg","81238_1.jpg","81238_2.jpg","81990_1.jpg","81990_2.jpg","83005_1.jpg","83005_2.jpg","83509_1.jpg","83509_2.jpg","83584_1.jpg","83584_2.jpg","84078_1.jpg","84078_2.jpg","84457_1.jpg","84457_2.jpg","85053_2.jpg","85053_1.jpg","85247_1.jpg","85247_2.jpg","85301_1.jpg","85301_2.jpg","85757_1.jpg","85757_2.jpg","87233_1.jpg","87233_2.jpg","87786_1.jpg","87786_2.jpg","88288_2.jpg","88288_1.jpg","88385_1.jpg","88385_2.jpg","88645_1.jpg","88645_2.jpg","89950_2.jpg","89950_1.jpg","90373_2.jpg","90373_1.jpg","90385_1.jpg","90385_2.jpg","90454_1.jpg","90454_2.jpg","90834_1.jpg","90834_2.jpg","91155_2.jpg","91155_1.jpg","91743_1.jpg","91743_2.jpg","300665_2.jpg","300665_1.jpg","306772_1.jpg","306772_2.jpg","309385_1.jpg","309385_2.jpg","309447_2.jpg","309447_1.jpg","310593_2.jpg","310593_3.jpg","312289_1.jpg","312289_2.jpg","313618_1.jpg","313618_2.jpg","315652_2.jpg","315652_1.jpg","318843_1.jpg","318843_2.jpg","319529_1.jpg","319529_2.jpg","319823_1.jpg","319823_2.jpg","320613_1.jpg","320613_2.jpg","221822_1.jpg","221822_2.jpg","221878_1.jpg","221878_2.jpg","222083_2.jpg","222083_1.jpg","228228_2.jpg","228228_1.jpg","228471_2.jpg","228471_1.jpg","223080_2.jpg","223080_1.jpg","226405_2.jpg","226405_1.jpg","229374_2.jpg","229374_1.jpg","223527_1.jpg","223527_2.jpg","229604_2.jpg","229604_1.jpg","230414_2.jpg","230414_1.jpg","224653_2.jpg","224653_1.jpg","227846_1.jpg","227846_2.jpg","227883_2.jpg","227883_1.jpg","230781_2.jpg","230781_1.jpg","230885_1.jpg","230885_2.jpg","241878_2.jpg","241878_1.jpg","236320_2.jpg","236320_1.jpg","242902_2.jpg","242902_1.jpg","242954_1.jpg","242954_2.jpg","233360_2.jpg","233360_1.jpg","236548_2.jpg","236548_1.jpg","236667_2.jpg","236667_1.jpg","239387_1.jpg","239387_2.jpg","233825_1.jpg","233825_2.jpg","236993_2.jpg","236993_1.jpg","234207_2.jpg","234207_1.jpg","237220_1.jpg","237220_2.jpg","240171_1.jpg","240171_2.jpg","242536_2.jpg","242536_1.jpg","237693_2.jpg","237693_1.jpg","237767_2.jpg","237767_1.jpg","240562_1.jpg","240562_2.jpg","242678_1.jpg","242678_2.jpg","234946_2.jpg","234946_1.jpg","238008_1.jpg","238008_2.jpg","240721_2.jpg","240721_1.jpg","232345_2.jpg","232345_1.jpg","232658_2.jpg","232658_1.jpg","238729_2.jpg","238729_1.jpg","238737_2.jpg","238737_1.jpg","235797_1.jpg","235797_2.jpg","235801_1.jpg","235801_2.jpg","246003_1.jpg","246003_2.jpg","248815_2.jpg","248815_1.jpg","248933_2.jpg","248933_1.jpg","251900_1.jpg","251900_2.jpg","254821_2.jpg","254821_1.jpg","254928_1.jpg","254928_2.jpg","246154_1.jpg","246154_2.jpg","255016_2.jpg","255016_1.jpg","255028_1.jpg","255028_3.jpg","252227_2.jpg","252227_1.jpg","252561_1.jpg","252561_2.jpg","246891_1.jpg","246891_2.jpg","246914_1.jpg","246914_2.jpg","249850_1.jpg","249850_2.jpg","249862_2.jpg","249862_1.jpg","247957_2.jpg","247957_1.jpg","248097_2.jpg","248097_1.jpg","254119_2.jpg","254119_1.jpg","254181_1.jpg","254181_2.jpg","248354_2.jpg","248354_1.jpg","266960_2.jpg","266960_1.jpg","263564_2.jpg","263564_1.jpg","258649_2.jpg","258649_1.jpg","261656_1.jpg","261656_2.jpg","102402_2.jpg","102402_1.jpg","102594_1.jpg","102594_2.jpg","107199_1.jpg","107199_2.jpg","107249_1.jpg","107249_2.jpg","100191_2.jpg","100191_1.jpg","100319_1.jpg","100319_2.jpg","101160_1.jpg","101160_2.jpg","106683_1.jpg","106683_2.jpg","107649_1.jpg","107649_2.jpg","107931_2.jpg","107931_1.jpg","107937_1.jpg","107937_2.jpg","107959_1.jpg","107959_2.jpg","108031_1.jpg","108031_2.jpg","106234_1.jpg","106234_2.jpg","106274_1.jpg","106274_2.jpg","106278_1.jpg","106278_2.jpg","106396_1.jpg","106396_2.jpg","109536_1.jpg","109536_2.jpg","109575_2.jpg","109575_1.jpg","109724_1.jpg","109724_2.jpg","109835_2.jpg","109835_1.jpg","110058_1.jpg","110058_2.jpg","110096_2.jpg","110096_1.jpg","110112_2.jpg","110112_1.jpg","109370_1.jpg","109370_2.jpg","109376_3.jpg","109376_4.jpg","111326_1.jpg","111326_2.jpg","111310_2.jpg","111310_1.jpg","108302_1.jpg","108302_2.jpg","108427_1.jpg","108427_2.jpg","111459_1.jpg","111459_2.jpg","108627_2.jpg","108627_1.jpg","108640_1.jpg","108640_2.jpg","108615_1.jpg","108615_2.jpg","110816_2.jpg","110816_1.jpg","110839_1.jpg","110839_2.jpg","110214_1.jpg","110214_2.jpg","110322_1.jpg","110322_2.jpg","111000_1.jpg","111000_2.jpg","109241_1.jpg","109241_3.jpg","109315_1.jpg","109315_2.jpg","103231_1.jpg","103231_2.jpg","103784_1.jpg","103784_2.jpg","104903_2.jpg","104903_1.jpg","104997_1.jpg","104997_2.jpg","105543_1.jpg","105543_2.jpg","105559_1.jpg","105559_2.jpg","105644_1.jpg","105644_2.jpg","105761_2.jpg","105761_1.jpg","322214_2.jpg","322214_1.jpg","23459_4.jpg","23459_2.jpg","37613_3.jpg","37613_2.jpg","39166_3.jpg","39166_2.jpg","63006_3.jpg","63006_2.jpg","100060_3.jpg","100060_2.jpg","104567_4.jpg","104567_3.jpg","106212_3.jpg","106212_1.jpg","106519_2.jpg","106519_1.jpg","106924_3.jpg","106924_4.jpg","106982_4.jpg","106982_3.jpg","107620_3.jpg","107620_2.jpg","107878_4.jpg","107878_3.jpg","108972_4.jpg","108972_3.jpg","109439_3.jpg","109439_5.jpg","109444_5.jpg","109444_3.jpg","110442_1.jpg","110442_3.jpg","110545_3.jpg","110545_4.jpg","110585_2.jpg","110585_1.jpg","110717_4.jpg","110717_1.jpg","111026_2.jpg","111026_5.jpg","111508_3.jpg","111508_1.jpg"]:
          continue
        # old correct (train, mmdl)
        # if this_img_id not in ["44_2.jpg","44_1.jpg","663_1.jpg","663_2.jpg","914_1.jpg","914_2.jpg","1104_1.jpg","1104_2.jpg","1167_1.jpg","1167_2.jpg","1821_1.jpg","1821_2.jpg","1859_1.jpg","1859_2.jpg","2754_1.jpg","2754_2.jpg","5558_1.jpg","5558_2.jpg","7115_1.jpg","7115_2.jpg","8311_2.jpg","8311_1.jpg","8983_1.jpg","8983_2.jpg","16171_2.jpg","16171_1.jpg","17217_1.jpg","17217_2.jpg","17281_2.jpg","17281_1.jpg","23240_1.jpg","23240_2.jpg","27434_1.jpg","27434_2.jpg","31372_1.jpg","31372_2.jpg","31912_1.jpg","31912_2.jpg","35264_2.jpg","35264_1.jpg","43455_1.jpg","43455_2.jpg","44503_1.jpg","44503_2.jpg","51272_1.jpg","51272_2.jpg","52905_2.jpg","52905_1.jpg","58238_1.jpg","58238_2.jpg","69667_1.jpg","69667_2.jpg","71586_1.jpg","71586_2.jpg","73122_1.jpg","73122_2.jpg","73265_2.jpg","73265_1.jpg","74550_1.jpg","74550_2.jpg","74737_1.jpg","74737_2.jpg","75909_2.jpg","75909_1.jpg","76517_1.jpg","76517_2.jpg","76843_1.jpg","76843_2.jpg","77043_1.jpg","77043_2.jpg","77134_1.jpg","77134_2.jpg","77755_1.jpg","77755_2.jpg","78975_1.jpg","78975_2.jpg","79491_2.jpg","79491_1.jpg","80859_1.jpg","80859_2.jpg","81062_1.jpg","81062_2.jpg","81269_1.jpg","81269_2.jpg","81425_1.jpg","81425_2.jpg","81576_1.jpg","81576_2.jpg","81948_2.jpg","81948_1.jpg","82100_1.jpg","82100_2.jpg","82121_1.jpg","82121_2.jpg","82349_1.jpg","82349_2.jpg","82624_1.jpg","82624_2.jpg","83227_1.jpg","83227_2.jpg","86389_1.jpg","86389_2.jpg","86668_1.jpg","86668_2.jpg","88497_1.jpg","88497_2.jpg","89244_1.jpg","89244_2.jpg","90839_1.jpg","90839_2.jpg","91546_2.jpg","91546_1.jpg","300946_1.jpg","300946_2.jpg","302136_4.jpg","302136_1.jpg","303360_3.jpg","303360_2.jpg","309888_1.jpg","309888_2.jpg","221313_2.jpg","221313_1.jpg","222881_1.jpg","222881_2.jpg","222973_1.jpg","222973_2.jpg","231994_1.jpg","231994_2.jpg","225300_1.jpg","225300_2.jpg","228601_1.jpg","228601_2.jpg","225685_1.jpg","225685_2.jpg","226312_1.jpg","226312_2.jpg","229299_1.jpg","229299_2.jpg","230046_2.jpg","230046_1.jpg","224193_2.jpg","224193_1.jpg","241709_2.jpg","241709_1.jpg","230923_1.jpg","230923_2.jpg","236269_2.jpg","236269_1.jpg","233822_1.jpg","233822_2.jpg","239678_2.jpg","239678_1.jpg","237123_2.jpg","237123_1.jpg","240134_2.jpg","240134_1.jpg","240369_1.jpg","240369_2.jpg","242775_2.jpg","242775_1.jpg","234976_1.jpg","234976_2.jpg","241082_2.jpg","241082_1.jpg","232772_1.jpg","232772_2.jpg","235625_2.jpg","235625_1.jpg","238582_2.jpg","238582_1.jpg","248485_1.jpg","248485_2.jpg","251726_1.jpg","251726_2.jpg","232730_1.jpg","232730_2.jpg","254872_2.jpg","254872_1.jpg","249029_1.jpg","249029_2.jpg","249428_2.jpg","249428_1.jpg","244489_2.jpg","244489_1.jpg","247396_2.jpg","247396_1.jpg","245050_1.jpg","245050_2.jpg","250847_2.jpg","250847_1.jpg","256897_2.jpg","256897_1.jpg","265551_2.jpg","265551_1.jpg","260865_1.jpg","260865_2.jpg","258233_2.jpg","258233_1.jpg","261283_1.jpg","261283_2.jpg","261659_1.jpg","261659_2.jpg","267601_1.jpg","267601_2.jpg","267860_2.jpg","267860_1.jpg","101853_1.jpg","101853_2.jpg","102198_1.jpg","102198_2.jpg","102367_2.jpg","102367_1.jpg","102702_2.jpg","102702_1.jpg","107231_1.jpg","107231_2.jpg","107267_1.jpg","107267_2.jpg","107268_1.jpg","107268_2.jpg","100081_2.jpg","100081_1.jpg","100070_1.jpg","100070_2.jpg","100193_1.jpg","100193_2.jpg","100602_1.jpg","100602_2.jpg","100757_1.jpg","100757_2.jpg","100750_1.jpg","100750_2.jpg","100903_1.jpg","100903_2.jpg","100996_2.jpg","100996_1.jpg","101309_3.jpg","101309_4.jpg","101447_2.jpg","101447_1.jpg","101715_2.jpg","101715_1.jpg","106521_1.jpg","106521_2.jpg","106556_2.jpg","106556_1.jpg","107005_1.jpg","107005_2.jpg","107041_1.jpg","107041_2.jpg","107110_1.jpg","107110_2.jpg","108757_1.jpg","108757_2.jpg","108756_1.jpg","108756_2.jpg","108801_1.jpg","108801_2.jpg","108811_1.jpg","108811_2.jpg","108832_1.jpg","108832_2.jpg","107831_1.jpg","107831_2.jpg","107965_1.jpg","107965_2.jpg","108115_2.jpg","108115_1.jpg","106323_1.jpg","106323_2.jpg","106381_1.jpg","106381_2.jpg","109533_2.jpg","109533_1.jpg","109587_1.jpg","109587_2.jpg","109688_1.jpg","109688_2.jpg","109748_1.jpg","109748_2.jpg","109773_2.jpg","109773_1.jpg","109795_1.jpg","109795_2.jpg","110122_1.jpg","110122_2.jpg","106465_2.jpg","106465_1.jpg","109387_2.jpg","109387_4.jpg","109420_4.jpg","109420_5.jpg","110497_1.jpg","110497_4.jpg","110806_2.jpg","110806_1.jpg","110811_2.jpg","110811_1.jpg","108518_2.jpg","108518_4.jpg","108604_1.jpg","108604_2.jpg","108948_1.jpg","108948_2.jpg","110311_2.jpg","110311_1.jpg","110953_2.jpg","110953_1.jpg","111041_1.jpg","111041_4.jpg","109130_3.jpg","109130_4.jpg","109146_1.jpg","109146_3.jpg","109222_1.jpg","109222_2.jpg","103311_2.jpg","103311_1.jpg","103861_1.jpg","103861_2.jpg","104000_1.jpg","104000_2.jpg","104392_2.jpg","104392_1.jpg","105409_2.jpg","105409_1.jpg","105468_2.jpg","105468_1.jpg","105671_1.jpg","105671_2.jpg","105782_1.jpg","105782_2.jpg","106093_2.jpg","106093_1.jpg","103048_1.jpg","103048_2.jpg","323106_2.jpg","323106_1.jpg","323015_1.jpg","323015_2.jpg","322955_1.jpg","322955_2.jpg","322396_2.jpg","322396_3.jpg","24500_3.jpg","24500_2.jpg","41272_2.jpg","41272_3.jpg","46736_3.jpg","46736_1.jpg","54267_3.jpg","54267_2.jpg","56731_1.jpg","56731_3.jpg","100194_3.jpg","100194_2.jpg","100611_3.jpg","100611_2.jpg","100620_3.jpg","100620_2.jpg","101002_5.jpg","101002_2.jpg","101180_2.jpg","101180_3.jpg","104339_3.jpg","104339_4.jpg","104737_2.jpg","104737_3.jpg","105096_1.jpg","105096_4.jpg","105177_4.jpg","105177_1.jpg","105507_4.jpg","105507_1.jpg","106317_4.jpg","106317_3.jpg","106983_2.jpg","106983_3.jpg","106999_4.jpg","106999_3.jpg","107405_2.jpg","107405_3.jpg","107654_4.jpg","107654_3.jpg","107868_2.jpg","107868_3.jpg","108449_5.jpg","108449_6.jpg","108589_2.jpg","108589_3.jpg","108702_1.jpg","108702_3.jpg","108856_2.jpg","108856_3.jpg","109038_4.jpg","109038_6.jpg","109093_1.jpg","109093_3.jpg","109111_3.jpg","109111_4.jpg","109201_1.jpg","109201_3.jpg","109338_2.jpg","109338_3.jpg","109578_3.jpg","109578_2.jpg","110513_2.jpg","110513_4.jpg","110517_2.jpg","110517_4.jpg","110567_2.jpg","110567_4.jpg","110615_3.jpg","110615_4.jpg","110618_3.jpg","110618_4.jpg","110678_3.jpg","110678_4.jpg","110742_2.jpg","110742_4.jpg","110810_2.jpg","110810_3.jpg","110867_1.jpg","110867_3.jpg","110869_5.jpg","110869_6.jpg","111051_4.jpg","111051_5.jpg","111110_4.jpg","111110_1.jpg","111257_3.jpg","111257_4.jpg","111266_5.jpg","111266_3.jpg","111292_1.jpg","111292_3.jpg","111295_3.jpg","111295_4.jpg","111315_2.jpg","111315_4.jpg","111336_4.jpg","111336_3.jpg","111354_4.jpg","111354_3.jpg","111368_5.jpg","111368_1.jpg","111463_3.jpg","111463_4.jpg","229473_3.jpg","229473_4.jpg","241986_1.jpg","241986_3.jpg","251974_3.jpg","251974_2.jpg"]:
        #   continue
        # young correct (test, mmdl)
        # if this_img_id not in ["284_1.jpg","284_2.jpg","1067_1.jpg","1067_2.jpg","1742_1.jpg","1742_2.jpg","11911_2.jpg","11911_1.jpg","15289_2.jpg","15289_1.jpg","29605_1.jpg","29605_2.jpg","32796_1.jpg","32796_2.jpg","43622_1.jpg","43622_2.jpg","50057_1.jpg","50057_2.jpg","63964_1.jpg","63964_2.jpg","70781_2.jpg","70781_1.jpg","71637_1.jpg","71637_2.jpg","72276_1.jpg","72276_2.jpg","72674_2.jpg","72674_1.jpg","72700_2.jpg","72700_1.jpg","72973_1.jpg","72973_2.jpg","73099_1.jpg","73099_2.jpg","73216_1.jpg","73216_2.jpg","73695_2.jpg","73695_1.jpg","73995_2.jpg","73995_1.jpg","74163_2.jpg","74163_1.jpg","74329_1.jpg","74329_2.jpg","76070_1.jpg","76070_2.jpg","77066_1.jpg","77066_2.jpg","77132_1.jpg","77132_2.jpg","77511_1.jpg","77511_2.jpg","77895_1.jpg","77895_2.jpg","78053_1.jpg","78053_2.jpg","78288_1.jpg","78288_2.jpg","79074_1.jpg","79074_2.jpg","80902_1.jpg","80902_2.jpg","84624_2.jpg","84624_1.jpg","85624_1.jpg","85624_2.jpg","90589_1.jpg","90589_2.jpg","90951_1.jpg","90951_2.jpg","91180_2.jpg","91180_1.jpg","91645_1.jpg","91645_2.jpg","221271_2.jpg","221271_1.jpg","222329_1.jpg","222329_2.jpg","221451_2.jpg","221451_1.jpg","221740_2.jpg","221740_1.jpg","232041_2.jpg","232041_1.jpg","225440_2.jpg","225440_1.jpg","228939_1.jpg","228939_2.jpg","229409_1.jpg","229409_2.jpg","223593_1.jpg","223593_2.jpg","226657_2.jpg","226657_1.jpg","229984_1.jpg","229984_2.jpg","224311_2.jpg","224311_1.jpg","224401_1.jpg","224401_2.jpg","230417_1.jpg","230417_2.jpg","233215_1.jpg","233215_2.jpg","242849_2.jpg","242849_1.jpg","242978_2.jpg","242978_1.jpg","236473_2.jpg","236473_1.jpg","233744_1.jpg","233744_2.jpg","236804_1.jpg","236804_2.jpg","237016_1.jpg","237016_2.jpg","239775_1.jpg","239775_2.jpg","234118_1.jpg","234118_2.jpg","238074_1.jpg","238074_2.jpg","248617_2.jpg","248617_1.jpg","246099_2.jpg","246099_1.jpg","246269_2.jpg","246269_1.jpg","247197_1.jpg","247197_2.jpg","250272_1.jpg","250272_2.jpg","247844_2.jpg","247844_1.jpg","250811_2.jpg","250811_1.jpg","250816_2.jpg","250816_1.jpg","245105_2.jpg","245105_1.jpg","256514_1.jpg","256514_2.jpg","256551_1.jpg","256551_2.jpg","255612_2.jpg","255612_1.jpg","102438_2.jpg","102438_1.jpg","107194_1.jpg","107194_2.jpg","100141_1.jpg","100141_2.jpg","100599_2.jpg","100599_1.jpg","101289_2.jpg","101289_3.jpg","106534_2.jpg","106534_1.jpg","108855_2.jpg","108855_1.jpg","107958_1.jpg","107958_2.jpg","106322_1.jpg","106322_2.jpg","109873_1.jpg","109873_2.jpg","110176_1.jpg","110176_2.jpg","106433_1.jpg","106433_2.jpg","110414_1.jpg","110414_2.jpg","110604_2.jpg","110604_1.jpg","111277_1.jpg","111277_2.jpg","108437_2.jpg","108437_3.jpg","108457_3.jpg","108457_4.jpg","110704_2.jpg","110704_1.jpg","110788_1.jpg","110788_2.jpg","111536_3.jpg","111536_4.jpg","108946_1.jpg","108946_2.jpg","110331_1.jpg","110331_2.jpg","111100_2.jpg","111100_1.jpg","111114_1.jpg","111114_2.jpg","109292_1.jpg","109292_2.jpg","103514_1.jpg","103514_2.jpg","103663_1.jpg","103663_2.jpg","103880_2.jpg","103880_1.jpg","103955_2.jpg","103955_1.jpg","104127_2.jpg","104127_1.jpg","104220_1.jpg","104220_2.jpg","104414_2.jpg","104414_1.jpg","105511_1.jpg","105511_2.jpg","105519_1.jpg","105519_2.jpg","105694_1.jpg","105694_2.jpg","106205_1.jpg","106205_2.jpg","323117_1.jpg","323117_2.jpg","322322_2.jpg","322322_1.jpg","321832_3.jpg","321832_4.jpg","21002_1.jpg","21002_3.jpg","53544_3.jpg","53544_2.jpg","53924_3.jpg","53924_1.jpg","103854_1.jpg","103854_2.jpg","103998_2.jpg","103998_3.jpg","104266_3.jpg","104266_4.jpg","107522_4.jpg","107522_3.jpg","107765_2.jpg","107765_4.jpg","109422_3.jpg","109422_4.jpg","110628_4.jpg","110628_5.jpg","110786_2.jpg","110786_1.jpg","110794_2.jpg","110794_1.jpg","111179_4.jpg","111179_3.jpg","223516_1.jpg","223516_4.jpg"]:
        #   continue
        # young all (test, mmdl)
        # if this_img_id not in ["159_1.jpg","159_2.jpg","284_1.jpg","284_2.jpg","1067_1.jpg","1067_2.jpg","1331_2.jpg","1331_1.jpg","1742_1.jpg","1742_2.jpg","11911_2.jpg","11911_1.jpg","15289_2.jpg","15289_1.jpg","15588_1.jpg","15588_2.jpg","15964_1.jpg","15964_2.jpg","17336_2.jpg","17336_1.jpg","17556_1.jpg","17556_2.jpg","28089_1.jpg","28089_2.jpg","29605_1.jpg","29605_2.jpg","32796_1.jpg","32796_2.jpg","43622_1.jpg","43622_2.jpg","50057_1.jpg","50057_2.jpg","50130_1.jpg","50130_2.jpg","63964_1.jpg","63964_2.jpg","69660_1.jpg","69660_2.jpg","70781_2.jpg","70781_1.jpg","71637_1.jpg","71637_2.jpg","72276_1.jpg","72276_2.jpg","72674_2.jpg","72674_1.jpg","72700_2.jpg","72700_1.jpg","72973_1.jpg","72973_2.jpg","73099_1.jpg","73099_2.jpg","73216_1.jpg","73216_2.jpg","73695_2.jpg","73695_1.jpg","73995_2.jpg","73995_1.jpg","74163_2.jpg","74163_1.jpg","74329_1.jpg","74329_2.jpg","76070_1.jpg","76070_2.jpg","77066_1.jpg","77066_2.jpg","77132_1.jpg","77132_2.jpg","77405_2.jpg","77405_1.jpg","77511_1.jpg","77511_2.jpg","77895_1.jpg","77895_2.jpg","78053_1.jpg","78053_2.jpg","78288_1.jpg","78288_2.jpg","79074_1.jpg","79074_2.jpg","80902_1.jpg","80902_2.jpg","84624_2.jpg","84624_1.jpg","85624_1.jpg","85624_2.jpg","90589_1.jpg","90589_2.jpg","90951_1.jpg","90951_2.jpg","91180_2.jpg","91180_1.jpg","91645_1.jpg","91645_2.jpg","300583_2.jpg","300583_1.jpg","320839_1.jpg","320839_2.jpg","221271_2.jpg","221271_1.jpg","222329_1.jpg","222329_2.jpg","221451_2.jpg","221451_1.jpg","221740_2.jpg","221740_1.jpg","232041_2.jpg","232041_1.jpg","225440_2.jpg","225440_1.jpg","228939_1.jpg","228939_2.jpg","229409_1.jpg","229409_2.jpg","223593_1.jpg","223593_2.jpg","226657_2.jpg","226657_1.jpg","229984_1.jpg","229984_2.jpg","224311_2.jpg","224311_1.jpg","224401_1.jpg","224401_2.jpg","230417_1.jpg","230417_2.jpg","233215_1.jpg","233215_2.jpg","242849_2.jpg","242849_1.jpg","242978_2.jpg","242978_1.jpg","236473_2.jpg","236473_1.jpg","233744_1.jpg","233744_2.jpg","236804_1.jpg","236804_2.jpg","237016_1.jpg","237016_2.jpg","239775_1.jpg","239775_2.jpg","234118_1.jpg","234118_2.jpg","238074_1.jpg","238074_2.jpg","248617_2.jpg","248617_1.jpg","246099_2.jpg","246099_1.jpg","246269_2.jpg","246269_1.jpg","247197_1.jpg","247197_2.jpg","250272_1.jpg","250272_2.jpg","247844_2.jpg","247844_1.jpg","250811_2.jpg","250811_1.jpg","250816_2.jpg","250816_1.jpg","245105_2.jpg","245105_1.jpg","256514_1.jpg","256514_2.jpg","256551_1.jpg","256551_2.jpg","255612_2.jpg","255612_1.jpg","102438_2.jpg","102438_1.jpg","107194_1.jpg","107194_2.jpg","100141_1.jpg","100141_2.jpg","100599_2.jpg","100599_1.jpg","101289_2.jpg","101289_3.jpg","106534_2.jpg","106534_1.jpg","108855_2.jpg","108855_1.jpg","107958_1.jpg","107958_2.jpg","106322_1.jpg","106322_2.jpg","109873_1.jpg","109873_2.jpg","110176_1.jpg","110176_2.jpg","106433_1.jpg","106433_2.jpg","110414_1.jpg","110414_2.jpg","110604_2.jpg","110604_1.jpg","111277_1.jpg","111277_2.jpg","108437_2.jpg","108437_3.jpg","108457_3.jpg","108457_4.jpg","110704_2.jpg","110704_1.jpg","110788_1.jpg","110788_2.jpg","111536_3.jpg","111536_4.jpg","108946_1.jpg","108946_2.jpg","110331_1.jpg","110331_2.jpg","111100_2.jpg","111100_1.jpg","111114_1.jpg","111114_2.jpg","109292_1.jpg","109292_2.jpg","103514_1.jpg","103514_2.jpg","103663_1.jpg","103663_2.jpg","103880_2.jpg","103880_1.jpg","103955_2.jpg","103955_1.jpg","104127_2.jpg","104127_1.jpg","104220_1.jpg","104220_2.jpg","104414_2.jpg","104414_1.jpg","104526_2.jpg","104526_1.jpg","105511_1.jpg","105511_2.jpg","105519_1.jpg","105519_2.jpg","105694_1.jpg","105694_2.jpg","106205_1.jpg","106205_2.jpg","323117_1.jpg","323117_2.jpg","322904_1.jpg","322904_2.jpg","322322_2.jpg","322322_1.jpg","321832_3.jpg","321832_4.jpg","321669_1.jpg","321669_2.jpg","21002_1.jpg","21002_3.jpg","53544_3.jpg","53544_2.jpg","53781_1.jpg","53781_3.jpg","53924_3.jpg","53924_1.jpg","103854_1.jpg","103854_2.jpg","103998_2.jpg","103998_3.jpg","104266_3.jpg","104266_4.jpg","107522_4.jpg","107522_3.jpg","107765_2.jpg","107765_4.jpg","109422_3.jpg","109422_4.jpg","110628_4.jpg","110628_5.jpg","110786_2.jpg","110786_1.jpg","110794_2.jpg","110794_1.jpg","111179_4.jpg","111179_3.jpg","223516_1.jpg","223516_4.jpg"]:
        #   continue
        # old correct (test, mmdl)
        # if this_img_id not in ["1830_1.jpg","1830_2.jpg","11180_1.jpg","11180_2.jpg","11274_1.jpg","11274_2.jpg","13752_1.jpg","13752_2.jpg","16410_1.jpg","16410_2.jpg","34296_1.jpg","34296_2.jpg","35165_2.jpg","35165_1.jpg","39997_1.jpg","39997_2.jpg","66189_2.jpg","66189_1.jpg","71481_1.jpg","71481_2.jpg","71819_1.jpg","71819_2.jpg","73671_1.jpg","73671_2.jpg","75350_2.jpg","75350_1.jpg","76542_1.jpg","76542_2.jpg","77374_2.jpg","77374_1.jpg","77768_1.jpg","77768_2.jpg","78125_1.jpg","78125_2.jpg","78860_1.jpg","78860_2.jpg","78916_2.jpg","78916_1.jpg","79027_1.jpg","79027_2.jpg","79888_1.jpg","79888_2.jpg","79924_1.jpg","79924_2.jpg","80083_2.jpg","80083_1.jpg","82560_2.jpg","82560_1.jpg","82687_2.jpg","82687_1.jpg","85036_2.jpg","85036_1.jpg","307023_1.jpg","307023_2.jpg","307450_1.jpg","307450_2.jpg","220927_1.jpg","220927_2.jpg","228379_1.jpg","228379_2.jpg","228382_2.jpg","228382_1.jpg","231413_1.jpg","231413_2.jpg","225820_2.jpg","225820_1.jpg","226214_2.jpg","226214_1.jpg","223888_2.jpg","223888_1.jpg","224369_2.jpg","224369_1.jpg","224604_1.jpg","224604_2.jpg","230551_2.jpg","230551_1.jpg","233149_2.jpg","233149_1.jpg","230901_1.jpg","230901_2.jpg","236133_1.jpg","236133_2.jpg","233465_2.jpg","233465_1.jpg","233693_1.jpg","233693_2.jpg","233698_2.jpg","233698_1.jpg","239570_2.jpg","239570_1.jpg","240153_2.jpg","240153_1.jpg","238093_2.jpg","238093_1.jpg","232607_1.jpg","232607_2.jpg","235475_1.jpg","235475_2.jpg","235624_1.jpg","235624_2.jpg","251768_1.jpg","251768_2.jpg","251874_1.jpg","251874_2.jpg","255090_2.jpg","255090_1.jpg","249264_1.jpg","249264_2.jpg","249303_2.jpg","249303_1.jpg","255212_1.jpg","255212_2.jpg","246614_2.jpg","246614_1.jpg","244145_2.jpg","244145_1.jpg","250068_1.jpg","250068_2.jpg","253214_1.jpg","253214_2.jpg","250734_1.jpg","250734_2.jpg","251066_1.jpg","251066_2.jpg","254350_1.jpg","254350_2.jpg","256778_1.jpg","256778_2.jpg","257904_2.jpg","257904_1.jpg","258474_2.jpg","258474_1.jpg","256075_2.jpg","256075_1.jpg","264907_1.jpg","264907_2.jpg","101837_1.jpg","101837_2.jpg","102625_1.jpg","102625_2.jpg","102813_2.jpg","102813_1.jpg","107174_1.jpg","107174_2.jpg","107280_1.jpg","107280_2.jpg","100113_1.jpg","100113_2.jpg","100461_1.jpg","100461_2.jpg","100616_1.jpg","100616_2.jpg","101560_1.jpg","101560_2.jpg","106571_1.jpg","106571_2.jpg","106849_1.jpg","106849_2.jpg","107164_1.jpg","107164_2.jpg","108147_1.jpg","108147_2.jpg","106335_2.jpg","106335_1.jpg","109778_1.jpg","109778_2.jpg","110188_1.jpg","110188_2.jpg","109362_1.jpg","109362_2.jpg","108251_3.jpg","108251_4.jpg","110427_1.jpg","110427_2.jpg","110486_2.jpg","110486_1.jpg","108478_1.jpg","108478_2.jpg","110769_3.jpg","110769_4.jpg","110795_1.jpg","110795_2.jpg","110798_1.jpg","110798_2.jpg","111401_2.jpg","111401_1.jpg","108928_3.jpg","108928_4.jpg","110923_1.jpg","110923_2.jpg","103340_1.jpg","103340_2.jpg","103692_2.jpg","103692_1.jpg","104336_1.jpg","104336_2.jpg","104383_2.jpg","104383_3.jpg","105542_1.jpg","105542_2.jpg","105618_1.jpg","105618_2.jpg","105907_1.jpg","105907_2.jpg","103075_1.jpg","103075_2.jpg","322282_1.jpg","322282_2.jpg","23957_3.jpg","23957_1.jpg","43342_2.jpg","43342_3.jpg","77001_2.jpg","77001_4.jpg","101754_3.jpg","101754_2.jpg","103902_3.jpg","103902_4.jpg","104186_1.jpg","104186_2.jpg","104657_1.jpg","104657_3.jpg","105536_4.jpg","105536_3.jpg","106922_2.jpg","106922_3.jpg","107465_3.jpg","107465_1.jpg","108481_3.jpg","108481_4.jpg","108929_3.jpg","108929_2.jpg","109060_3.jpg","109060_4.jpg","109661_3.jpg","109661_1.jpg","110355_1.jpg","110355_3.jpg","110738_2.jpg","110738_4.jpg","110785_5.jpg","110785_3.jpg","110907_3.jpg","110907_1.jpg","110933_4.jpg","110933_3.jpg","111164_2.jpg","111164_1.jpg","111358_4.jpg","111358_3.jpg"]:
        #   continue
        
        
        

        with tf.GradientTape() as tape:

            # https://stackoverflow.com/questions/55066710/computing-gradients-wrt-model-inputs-in-tensorflow-eager-mode
            input_image=batch[0]['image']
            tape.watch(input_image)
            # input_image = tf.Variable(batch[0]['image'], dtype=tf.float32)

            print('batch_idx, this_img_id',batch_idx, this_img_id)
            predictions = model([input_image, batch[0]['age'], batch[0]['sex'], batch[0]['blood'], batch[0]['bilirubin'], batch[0]['urobilinogen'], batch[0]['ketone'], batch[0]['protein'], batch[0]['nitrite'], batch[0]['glucose'], batch[0]['leucocyte'], batch[0]['ph'], batch[0]['sg']], training=False)
            # grad_val = tape.gradient(predictions['gt60'], predictions['A_K'])
            grad_val = tape.gradient(predictions['gt60'], input_image)
            # print('grad_val',grad_val.shape)
            # grad_val (1, 512, 512, 3)
            # print('grad_val',grad_val)

            # print(grad_val.numpy())

        # [conv_output, grad_val] = get_output([batch[0]['image'], batch[0]['sex'], batch[0]['age']])
        # conv_output = predictions['A_K'][0]
        conv_output = batch[0]['image']
        # print('conv_output',conv_output.shape)
        # conv_output (1, 512, 512, 3)

        # print('conv_output',type(conv_output))
        # conv_output <class 'tensorflow.python.framework.ops.EagerTensor'>

        # print(conv_output.numpy().squeeze().shape)
        # (512, 512, 3)


        # print('grad_val',grad_val.numpy().squeeze().shape)
        # grad_val (512, 512, 3)









        dgrad_abs = tf.math.abs(grad_val)
        dgrad_max_ = np.max(dgrad_abs, axis=3)[0]
        # print('dgrad_max_',dgrad_max_)
        arr_min, arr_max  = np.min(dgrad_max_), np.max(dgrad_max_)
        grad_eval = (dgrad_max_ - arr_min) / (arr_max - arr_min + 1e-18)
        # print('grad_eval',grad_eval)
        # print('grad_eval',grad_eval.shape)

        # fig, axes = plt.subplots(1,2,figsize=(14,5))
        # axes[0].imshow(_img)
        # i = axes[1].imshow(grad_eval,cmap="jet",alpha=0.8)
        # fig.colorbar(i)

        # import matplotlib.pyplot as plt
        # from datetime import datetime
        # # plt.imshow(grad_val.numpy().squeeze())
        # plt.imshow(grad_eval,cmap="jet")
        # plt.savefig('./temp_imgs/{}.png'.format(datetime.now().strftime('%Y_%m_%d_%H_%M_%S')),dpi=1000)


        input_images.append(batch[1]['ori_image'][0].numpy())
        saliency_maps_retina.append(grad_eval)


        # afaf


        # # conv_output (512, 512, 3)

        # ## 배치 사이즈가 1이므로 배치 차원을 없앤다.
        # # predictions = conv_output[0]
        # # print(grad_val.shape)
        # print("grad_val.shape",grad_val)
        # grad_val = grad_val[0]
        # # print(conv_output.shape)
        # afaf

        # ## 구한 gradient를 픽셀 가로세로로 평균내서 a^c_k를 구한다.
        # weights = np.mean(grad_val, axis=(0, 1))

        # ## 추출한 conv_output에 weight를 곱하고 합하여 grad_cam을 얻는다.
        # grad_cam = np.zeros(dtype=np.float32, shape=conv_output.shape[0:2])
        # for k, w in enumerate(weights):
        #     grad_cam += w * conv_output[:, :, k]

        # grad_cam = grad_cam.numpy()
        # grad_cam = cv.resize(grad_cam, (512, 512))

        # ## ReLU를 씌워 음수를 0으로 만든다.
        # grad_cam = np.maximum(grad_cam, 0)

        # grad_cam = grad_cam / grad_cam.max()
        # input_images.append(batch[1]['ori_image'][0].numpy())
        # saliency_maps_retina.append(grad_cam)

    return input_images, saliency_maps_retina

def getSmoothVanillaSaliencyMap(model, inputs, class_name, activation_layer):
    
    n_samples     = 25
    stdev_spread  = 0.15
    # stdev_spread  = 0.95
    input_images, saliency_maps_retina = [], []
    for (batch_idx, (batch)) in enumerate(inputs):
        this_img_id=batch[1]['img_id'].numpy()[0].decode('utf-8')
        # if batch_idx not in [14799, 17732, 19282, 21955, 22384, 24583, 26477, 28001, 29143, 30886]:
        # MMDL train all
        if this_img_id not in ["77_1.jpg","77_2.jpg","102_1.jpg","102_2.jpg","940_2.jpg","940_1.jpg","1496_2.jpg","1496_1.jpg","1573_2.jpg","1573_1.jpg","2735_1.jpg","2735_2.jpg","4399_1.jpg","4399_2.jpg","8989_1.jpg","8989_2.jpg","9212_1.jpg","9212_2.jpg","9443_1.jpg","9443_2.jpg","14584_1.jpg","14584_2.jpg","15649_1.jpg","15649_2.jpg","16434_1.jpg","16434_2.jpg","16588_1.jpg","16588_2.jpg","18701_1.jpg","18701_2.jpg","26545_1.jpg","26545_2.jpg","29867_1.jpg","29867_2.jpg","33822_1.jpg","33822_2.jpg","34101_1.jpg","34101_2.jpg","42742_2.jpg","42742_1.jpg","44009_1.jpg","44009_2.jpg","45856_1.jpg","45856_2.jpg","51584_1.jpg","51584_2.jpg","51926_1.jpg","51926_2.jpg","55027_1.jpg","55027_2.jpg","58160_1.jpg","58160_2.jpg","61742_1.jpg","61742_2.jpg","63333_1.jpg","63333_2.jpg","70037_1.jpg","70037_2.jpg","71986_2.jpg","71986_1.jpg","72259_1.jpg","72259_2.jpg","73107_1.jpg","73107_2.jpg","73201_2.jpg","73201_1.jpg","73935_1.jpg","73935_2.jpg","74505_1.jpg","74505_2.jpg","75088_1.jpg","75088_2.jpg","75418_1.jpg","75418_2.jpg","76223_2.jpg","76223_1.jpg","76712_1.jpg","76712_2.jpg","77477_2.jpg","77477_1.jpg","78307_1.jpg","78307_2.jpg","78353_1.jpg","78353_2.jpg","79137_1.jpg","79137_2.jpg","79261_1.jpg","79261_2.jpg","79818_1.jpg","79818_2.jpg","80392_1.jpg","80392_2.jpg","80575_1.jpg","80575_2.jpg","83005_1.jpg","83005_2.jpg","83584_1.jpg","83584_2.jpg","85247_1.jpg","85247_2.jpg","85301_1.jpg","85301_2.jpg","87233_1.jpg","87233_2.jpg","87786_1.jpg","87786_2.jpg","88288_2.jpg","88288_1.jpg","88385_1.jpg","88385_2.jpg","88645_1.jpg","88645_2.jpg","90385_1.jpg","90385_2.jpg","90454_1.jpg","90454_2.jpg","91155_2.jpg","91155_1.jpg","91743_1.jpg","91743_2.jpg","306772_1.jpg","306772_2.jpg","309385_1.jpg","309385_2.jpg","309447_2.jpg","309447_1.jpg","310593_2.jpg","310593_3.jpg","313618_1.jpg","313618_2.jpg","319823_1.jpg","319823_2.jpg","320613_1.jpg","320613_2.jpg","221822_1.jpg","221822_2.jpg","221878_1.jpg","221878_2.jpg","222083_2.jpg","222083_1.jpg","228228_2.jpg","228228_1.jpg","228471_2.jpg","228471_1.jpg","223080_2.jpg","223080_1.jpg","226405_2.jpg","226405_1.jpg","229374_2.jpg","229374_1.jpg","223527_1.jpg","223527_2.jpg","229604_2.jpg","229604_1.jpg","230414_2.jpg","230414_1.jpg","224653_2.jpg","224653_1.jpg","227846_1.jpg","227846_2.jpg","227883_2.jpg","227883_1.jpg","230781_2.jpg","230781_1.jpg","230885_1.jpg","230885_2.jpg","241878_2.jpg","241878_1.jpg","236320_2.jpg","236320_1.jpg","242902_2.jpg","242902_1.jpg","242954_1.jpg","242954_2.jpg","233360_2.jpg","233360_1.jpg","236548_2.jpg","236548_1.jpg","236667_2.jpg","236667_1.jpg","239387_1.jpg","239387_2.jpg","233825_1.jpg","233825_2.jpg","236993_2.jpg","236993_1.jpg","234207_2.jpg","234207_1.jpg","237220_1.jpg","237220_2.jpg","240171_1.jpg","240171_2.jpg","242536_2.jpg","242536_1.jpg","237693_2.jpg","237693_1.jpg","237767_2.jpg","237767_1.jpg","240562_1.jpg","240562_2.jpg","242678_1.jpg","242678_2.jpg","234946_2.jpg","234946_1.jpg","238008_1.jpg","238008_2.jpg","240721_2.jpg","240721_1.jpg","232345_2.jpg","232345_1.jpg","232658_2.jpg","232658_1.jpg","238729_2.jpg","238729_1.jpg","238737_2.jpg","238737_1.jpg","235797_1.jpg","235797_2.jpg","235801_1.jpg","235801_2.jpg","246003_1.jpg","246003_2.jpg","248815_2.jpg","248815_1.jpg","248933_2.jpg","248933_1.jpg","251900_1.jpg","251900_2.jpg","254821_2.jpg","254821_1.jpg","254928_1.jpg","254928_2.jpg","246154_1.jpg","246154_2.jpg","255016_2.jpg","255016_1.jpg","255028_1.jpg","255028_3.jpg","252227_2.jpg","252227_1.jpg","252561_1.jpg","252561_2.jpg","246891_1.jpg","246891_2.jpg","246914_1.jpg","246914_2.jpg","249850_1.jpg","249850_2.jpg","249862_2.jpg","249862_1.jpg","247957_2.jpg","247957_1.jpg","248097_2.jpg","248097_1.jpg","254119_2.jpg","254119_1.jpg","254181_1.jpg","254181_2.jpg","248354_2.jpg","248354_1.jpg","266960_2.jpg","266960_1.jpg","263564_2.jpg","263564_1.jpg","258649_2.jpg","258649_1.jpg","261656_1.jpg","261656_2.jpg","102402_2.jpg","102402_1.jpg","102594_1.jpg","102594_2.jpg","107199_1.jpg","107199_2.jpg","107249_1.jpg","107249_2.jpg","100191_2.jpg","100191_1.jpg","100319_1.jpg","100319_2.jpg","101160_1.jpg","101160_2.jpg","106683_1.jpg","106683_2.jpg","107649_1.jpg","107649_2.jpg","107931_2.jpg","107931_1.jpg","107937_1.jpg","107937_2.jpg","107959_1.jpg","107959_2.jpg","108031_1.jpg","108031_2.jpg","106234_1.jpg","106234_2.jpg","106274_1.jpg","106274_2.jpg","106278_1.jpg","106278_2.jpg","106396_1.jpg","106396_2.jpg","109536_1.jpg","109536_2.jpg","109575_2.jpg","109575_1.jpg","109724_1.jpg","109724_2.jpg","109835_2.jpg","109835_1.jpg","110058_1.jpg","110058_2.jpg","110096_2.jpg","110096_1.jpg","110112_2.jpg","110112_1.jpg","109370_1.jpg","109370_2.jpg","109376_3.jpg","109376_4.jpg","111326_1.jpg","111326_2.jpg","111310_2.jpg","111310_1.jpg","108302_1.jpg","108302_2.jpg","108427_1.jpg","108427_2.jpg","111459_1.jpg","111459_2.jpg","108627_2.jpg","108627_1.jpg","108640_1.jpg","108640_2.jpg","108615_1.jpg","108615_2.jpg","110816_2.jpg","110816_1.jpg","110839_1.jpg","110839_2.jpg","110214_1.jpg","110214_2.jpg","110322_1.jpg","110322_2.jpg","111000_1.jpg","111000_2.jpg","109241_1.jpg","109241_3.jpg","109315_1.jpg","109315_2.jpg","103231_1.jpg","103231_2.jpg","103784_1.jpg","103784_2.jpg","104997_1.jpg","104997_2.jpg","105559_1.jpg","105559_2.jpg","105644_1.jpg","105644_2.jpg","23459_4.jpg","23459_2.jpg","63006_3.jpg","63006_2.jpg","100060_3.jpg","100060_2.jpg","104567_4.jpg","104567_3.jpg","106212_3.jpg","106212_1.jpg","106519_2.jpg","106519_1.jpg","106924_3.jpg","106924_4.jpg","106982_4.jpg","106982_3.jpg","107620_3.jpg","107620_2.jpg","107878_4.jpg","107878_3.jpg","108972_4.jpg","108972_3.jpg","109439_3.jpg","109439_5.jpg","109444_5.jpg","109444_3.jpg","110442_1.jpg","110442_3.jpg","110545_3.jpg","110545_4.jpg","110585_2.jpg","110585_1.jpg","110717_4.jpg","110717_1.jpg","111026_2.jpg","111026_5.jpg","111508_3.jpg","111508_1.jpg"]:
        # if this_img_id not in ['104336_1.jpg', '249264_2.jpg','237016_2.jpg','228382_2.jpg','228382_1.jpg','233693_1.jpg','233693_2.jpg','237016_1.jpg','246269_2.jpg','246269_1.jpg','249264_1.jpg','245105_2.jpg','245105_1.jpg','251066_1.jpg','251066_2.jpg','102625_1.jpg','102625_2.jpg','106335_2.jpg','106335_1.jpg','104336_2.jpg']:
          continue
        
        stdev = stdev_spread / (batch[0]['image'].numpy().max() - batch[0]['image'].numpy().min())
        std_tensor = np.ones_like(batch[0]['image']) * stdev
        
        print('batch_idx, this_img_id',batch_idx, this_img_id)
        
        for i in range(n_samples):
        
          with tf.GradientTape() as tape:

              # https://stackoverflow.com/questions/55066710/computing-gradients-wrt-model-inputs-in-tensorflow-eager-mode
              input_image=batch[0]['image']

              # Noised input image
              noised_input_image=copy.deepcopy(input_image)+tf.random.normal(batch[0]['image'].shape, mean=0, stddev=stdev)

              tape.watch(noised_input_image)

              predictions = model([noised_input_image, batch[0]['age'], batch[0]['sex'], batch[0]['blood'], batch[0]['bilirubin'], batch[0]['urobilinogen'], batch[0]['ketone'], batch[0]['protein'], batch[0]['nitrite'], batch[0]['glucose'], batch[0]['leucocyte'], batch[0]['ph'], batch[0]['sg']], training=False)

              grad_val = tape.gradient(predictions['gt60'], noised_input_image)

          conv_output = batch[0]['image']

          dgrad_abs = tf.math.abs(grad_val)
          dgrad_max_ = np.max(dgrad_abs, axis=3)[0]
          arr_min, arr_max  = np.min(dgrad_max_), np.max(dgrad_max_)
          grad_eval = (dgrad_max_ - arr_min) / (arr_max - arr_min + 1e-18)

          if i == 0:
              total_cams = grad_eval.copy()
          else:
              total_cams += grad_eval

        input_images.append(batch[1]['ori_image'][0].numpy())
        saliency_maps_retina.append(total_cams/n_samples)                    # 25개의 noise 추가된 input으로 부터 생성된 saliency map들을 평균함

    return input_images, saliency_maps_retina


def getSmoothGradCAMPP(model, inputs, class_name, activation_layer):
    """
    Args:
        x: input image. shape =>(1, 3, H, W)
    Return:
        Total_cams: mean of class activation mappings of n_samples
    """
    n_samples     = 25
    stdev_spread  = 0.15
    input_images, saliency_maps_retina = [], []
    for (batch_idx, (batch)) in enumerate(inputs):
        this_img_id=batch[1]['img_id'].numpy()[0].decode('utf-8')
        
        if this_img_id not in ['228382_2.jpg','228382_1.jpg','233693_1.jpg','233693_2.jpg','237016_1.jpg','237016_2.jpg','246269_2.jpg','246269_1.jpg','249264_1.jpg','249264_2.jpg','245105_2.jpg','245105_1.jpg','251066_1.jpg','251066_2.jpg','102625_1.jpg','102625_2.jpg','106335_2.jpg','106335_1.jpg','104336_1.jpg','104336_2.jpg']:
          continue

        stdev = stdev_spread / (batch[0]['image'].numpy().max() - batch[0]['image'].numpy().min())
        std_tensor = np.ones_like(batch[0]['image']) * stdev
        
        print('batch_idx, this_img_id',batch_idx, this_img_id)
        
        for i in range(n_samples):
            # Noised input image
            image = batch[0]['image'] + tf.random.normal(batch[0]['image'].shape, mean=0, stddev=stdev)
            
            with tf.GradientTape() as tape:

                # Forward pass with noised input image
                predictions = model([batch[0]['image'], batch[0]['age'], batch[0]['sex'], batch[0]['blood'], batch[0]['bilirubin'], 
                                     batch[0]['urobilinogen'], batch[0]['ketone'], batch[0]['protein'], batch[0]['nitrite'], 
                                     batch[0]['glucose'], batch[0]['leucocyte'], batch[0]['ph'], batch[0]['sg']], training=False)

                # Gradient of class score with respect to feature map (from noised input)
                grad_val = tape.gradient(predictions['gt60'], predictions['A_K'])

            # class_score, conv_first_grad, conv_second_grad,conv_third_grad, conv_layer_output, grads_val = gradient_function([image, batch[0]['sex'], batch[0]['age']])
            
            # feature map (from noised input)
            conv_layer_output = predictions['A_K']
            
            # print(conv_layer_output.numpy().shape)

            # Gradients from noised input
            conv_first_grad  = tf.math.exp(predictions['gt60']) * grad_val
            conv_second_grad = tf.math.exp(predictions['gt60']) * grad_val * grad_val
            conv_third_grad  = tf.math.exp(predictions['gt60']) * grad_val * grad_val * grad_val

            global_sum = np.sum(conv_layer_output[0].numpy().reshape((-1,conv_first_grad[0].shape[2])), axis=0)
            
            alpha_num   = conv_second_grad[0]
            alpha_denom = conv_second_grad[0] * 2.0 + conv_third_grad[0] * global_sum.reshape((1,1,conv_first_grad[0].shape[2]))
            alpha_denom = np.where(alpha_denom != 0.0, alpha_denom, np.ones(alpha_denom.shape))
            alphas = alpha_num/alpha_denom

            weights = np.maximum(conv_first_grad[0], 0.0)
            
            alphas_thresholding = np.where(weights, alphas, 0.0)

            alpha_normalization_constant = np.sum(np.sum(alphas_thresholding, axis=0),axis=0)
            alpha_normalization_constant_processed = np.where(alpha_normalization_constant != 0.0, alpha_normalization_constant, np.ones(alpha_normalization_constant.shape))

            alphas /= alpha_normalization_constant_processed.reshape((1,1,conv_first_grad[0].shape[2]))
            
            deep_linearization_weights = np.sum((weights * alphas).numpy().reshape((-1,conv_first_grad[0].shape[2])),axis=0)
            
            grad_CAM_map = np.sum(deep_linearization_weights*conv_layer_output[0], axis=2)

                
            # Passing through ReLU
            cam = np.maximum(grad_CAM_map, 0)
            cam = zoom(cam,512/cam.shape[0])
            # smg_cam = cam / np.max(cam) # scale 0 to 1.0
            smg_cam = (cam - np.min(cam)) / (np.max(cam) - np.min(cam)) # scale 0 to 1.0
            # print('smg_cam',smg_cam.min())
            # print('smg_cam',smg_cam.max())

            # smg_cam = getGradCAMPlusPlus(model, inputs, class_name, target_layer, x_with_noise)
            #smg_cam = cam(GradCAMPlusPlus,self.model,self.target_layer,self.prediction,x_with_noise)

            if i == 0:
                total_cams = smg_cam.copy()
            else:
                total_cams += smg_cam

        total_cams /= n_samples
        # input_images.append(batch[0]['image'][0].numpy())
        # print('batch[1]["ori_image"][0].numpy()',batch[1]['ori_image'][0].numpy().shape)
        # print('total_cams',total_cams.shape)
        # batch[1]["ori_image"][0].numpy() (512, 512, 3)
        # total_cams (512, 512)
        input_images.append(batch[1]['ori_image'][0].numpy())
        saliency_maps_retina.append(total_cams)
    
    return input_images, saliency_maps_retina


def getGradCAMPP(model, inputs, class_name, target_layer):
    
    input_images, saliency_maps_retina = [], []
    for (batch_idx, (batch)) in enumerate(inputs):
        print(batch_idx)
        if batch_idx==10:
          break
        with tf.GradientTape() as tape:
            predictions = model([batch[0]['image'], batch[0]['age'], batch[0]['sex'], batch[0]['blood'], batch[0]['bilirubin'], batch[0]['urobilinogen'], batch[0]['ketone'], batch[0]['protein'], batch[0]['nitrite'], batch[0]['glucose'], batch[0]['leucocyte'], batch[0]['ph'], batch[0]['sg']], training=False)
            grad_val = tape.gradient(predictions['gt60'], predictions['A_K'])

        # class_score, conv_first_grad, conv_second_grad,conv_third_grad, conv_layer_output, grads_val = gradient_function([image, batch[0]['sex'], batch[0]['age']])
        
        conv_layer_output = predictions['A_K']
        # print(conv_layer_output.numpy().shape)
        conv_first_grad  = tf.math.exp(predictions['gt60']) * grad_val
        conv_second_grad = tf.math.exp(predictions['gt60']) * grad_val * grad_val
        conv_third_grad  = tf.math.exp(predictions['gt60']) * grad_val * grad_val * grad_val

        global_sum = np.sum(conv_layer_output[0].numpy().reshape((-1,conv_first_grad[0].shape[2])), axis=0)
        
        alpha_num   = conv_second_grad[0]
        alpha_denom = conv_second_grad[0] * 2.0 + conv_third_grad[0] * global_sum.reshape((1,1,conv_first_grad[0].shape[2]))
        alpha_denom = np.where(alpha_denom != 0.0, alpha_denom, np.ones(alpha_denom.shape))
        # print('alpha_denom',alpha_denom)
        alphas = alpha_num/alpha_denom

        weights = np.maximum(conv_first_grad[0], 0.0)
        
        alphas_thresholding = np.where(weights, alphas, 0.0)

        alpha_normalization_constant = np.sum(np.sum(alphas_thresholding, axis=0),axis=0)
        alpha_normalization_constant_processed = np.where(alpha_normalization_constant != 0.0, alpha_normalization_constant, np.ones(alpha_normalization_constant.shape))

        # print('alpha_normalization_constant_processed.reshape((1,1,conv_first_grad[0].shape[2]))',alpha_normalization_constant_processed.reshape((1,1,conv_first_grad[0].shape[2])))
        alphas /= alpha_normalization_constant_processed.reshape((1,1,conv_first_grad[0].shape[2]))
        
        deep_linearization_weights = np.sum((weights * alphas).numpy().reshape((-1,conv_first_grad[0].shape[2])),axis=0)
        
        grad_CAM_map = np.sum(deep_linearization_weights*conv_layer_output[0], axis=2)
        # print('grad_CAM_map',grad_CAM_map)

        if batch_idx==2:
          print('grad_CAM_map',grad_CAM_map)

        # Passing through ReLU
        cam = np.maximum(grad_CAM_map, 0)
        # print('cam.shape[0]',cam.shape[0])
        cam = zoom(cam,512/cam.shape[0])
        
        # print('np.max(cam)',np.max(cam))
        cam = cam / (np.max(cam)) # scale 0 to 1.0
        input_images.append(batch[1]['ori_image'][0].numpy())
        saliency_maps_retina.append(cam)
    
    return input_images, saliency_maps_retina